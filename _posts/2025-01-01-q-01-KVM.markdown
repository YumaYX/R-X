---
layout: post
title: KVM
category: "Virtualization"
---

KVM 仮想化環境を構築し、Kickstart を使った自動インストールで仮想マシンを作成する手順の概要です。加えて、インターネット経由やローカルISOファイルからの仮想マシン作成方法も示しています。

まず、KVMの動作に必要なパッケージ（qemu-kvm、libvirt、virt-install）をインストールし、libvirtdサービスを有効化かつ起動します。

```sh
dnf -y install qemu-kvm libvirt virt-install
systemctl enable --now libvirtd
```

仮想マシンの停止や削除は以下のコマンドで行います。

```sh
virsh shutdown guest1-rhx       # ゲストの正常シャットダウン
virsh destroy guest1-rhx        # 強制停止
virsh undefine guest1-rhx --remove-all-storage  # 設定とディスクを完全削除

```

# kickstart

/tmp/ks.cfg に保存したKickstartファイルでは、キーボード設定や言語、ネットワーク、パーティション構成、タイムゾーン、rootパスワードなどをあらかじめ指定します。
仮想ディスクは KVM環境の特性に合わせて vda として指定しています。

```sh
cat << 'KICKSTART' > /tmp/ks.cfg
text
reboot
cdrom

keyboard --vckeymap=jp106 --xlayouts='jp','us'
# keyboard --vckeymap=us --xlayouts='us','jp'
lang en_US.UTF-8

network --bootproto=dhcp --ipv6=auto --activate --hostname=localhost
zerombr

%packages
@core
%end

ignoredisk --only-use=vda
autopart
clearpart --all --initlabel

timezone Asia/Tokyo --utc

rootpw --iscrypted --allow-ssh $6$EkGHWaJKwbybILqx$DwIwbw5NOGm2LpNlaCIRCeckcOlHACxMMfsyYijZ0uEKmGTHmDSqQhs4ndUGpme5uZl7zg/aJyam8j9N6wWRG.
KICKSTART
```

## from the internet

URLで指定したリポジトリからAlmaLinuxのインストールイメージを取得し、Kickstartで自動インストールします。

```sh
virt-install \
  --name guest1-rhx \
  --memory 4096 \
  --vcpus 4 \
  --network default \
  --disk size=20 \
  --location http://ftp.riken.jp/Linux/almalinux/10.0/BaseOS/x86_64/os/ \
  --os-variant rhel9.4 \
  --graphics none \
  --accelerate \
  --initrd-inject /tmp/ks.cfg \
  --extra-args "console=tty0 console=ttyS0,115200n8 inst.ks=file:/ks.cfg"
```

## from a local file

あらかじめISOをダウンロードしておき、ローカルファイルを指定して仮想マシンを作成する方法です。

```sh
isouri='https://repo.almalinux.org/almalinux/10/isos/x86_64/AlmaLinux-10.0-x86_64-minimal.iso'
curl -O "${isouri}"
isofile=$(basename ${isouri})

virt-install \
  --name guest1-rhx \
  --memory 4096 \
  --vcpus 4 \
  --network default \
  --disk size=20 \
  --location "${isofile}" \
  --os-variant rhel9.4 \
  --graphics none \
  --accelerate \
  --initrd-inject /tmp/ks.cfg \
  --extra-args "console=tty0 console=ttyS0,115200n8 inst.ks=file:/ks.cfg"
```

# Vagrant

2025年5月31日時点では、AlmaLinux 10用の公式Vagrantリポジトリが存在しないため、Vagrantを使った簡単な環境構築は現状できません。
